// Title of Detection:   PowerShell Hacker Tools and their popular  Cmdlets
// Authorship & Contact: https://allthingscomputers.medium.com  https://twitter.com/allthingshandle  https://allthingscomputersblog.wordpress.com/ 
// Description of the Detection:  This detects PowerShell Cmdlets from PowerShell Tools including MimiKatz, PowerSploit, PowerView, Nishang, PowerUp and Empire  
// References (if available):  https://adsecurity.org/?p=2921 
// The Logic of the Detection or Query Begins Below This Line
SysmonEvent
| where Image contains "powershell" and CommandLine matches regex '(?I)Invoke-DllInjection.ps1|Invoke-Shellcode.ps1|Invoke-WmiCommand.ps1|Get-GPPPassword.ps1|Get-Keystrokes.ps1|Get-TimedScreenshot.ps1|Get-VaultCredential.ps1|Invoke-CredentialInjection.ps1|Invoke-Mimikatz.ps1|Invoke-NinjaCopy.ps1|Invoke-TokenManipulation.ps1|Out-Minidump.ps1|VolumeShadowCopyTools.ps1|Invoke-ReflectivePEInjection.ps1|Invoke-Mimikatz|PowerView|Get-NetUser|Get-NetGroup|Get-NetGroupMember|Get-NetLocalGroup|Get-NetSession|Invoke-UserHunter|Get-NetOU|Find-GPOLocation|Get-NetGPOGroup|Get-ObjectACL|Add-ObjectACL|Invoke-ACLScanner|Set-ADObject|Invoke-DowngradeAccount|Get-NetForest|Get-NetForestTrust|Get-NetForestDomain|Get-NetDomainTrust|Get-MapDomainTrust|AD-Recon-PowerView-GetNetGPOGroup-01|PowerUp|Get-ServiceUnquoted|Get-ServiceFilePermission|Get-ServicePermission|Invoke-ServiceAbuse|Install-ServiceBinary|Get-RegAutoLogon|Get-VulnAutoRun|Get-VulnSchTask|Get-UnattendedInstallFile|Get-WebConfig|Get-ApplicationHost|Get-RegAlwaysInstallElevated|Nishang|Get-Unconstrained|Add-RegBackdoor|Add-ScrnSaveBackdoor|Gupt-Backdoor|Invoke-ADSBackdoor|Enabled-DuplicateToken|Invoke-PsUaCme|Remove-Update|Check-VM|Copy-VSS|Get-Information|Get-LSASecret|Get-PassHashes|Invoke-Mimikatz|Show-TargetScreen|Port-Scan|Invoke-PoshRatHttp|Invoke-PowerShellTCP|Invoke-PowerShellWMI|Add-Exfiltration|Add-Persistence|Do-Exfiltration|Start-CaptureServer|Invoke-DllInjection|Invoke-ReflectivePEInjection|Invoke-ShellCode|Get-ChromeDump|Get-ClipboardContents|Get-FoxDump|Get-IndexedItem|Get-Keystrokes|Get-Screenshot|Invoke-Inveigh|Invoke-NetRipper|Invoke-NinjaCopy|Out-Minidump|Invoke-EgressCheck|Invoke-PostExfil|Invoke-PSInject|Invoke-RunAs|MailRaider|New-HoneyHash|Set-MacAttribute|Get-VaultCredential|Invoke-DCSync|Invoke-Mimikatz|Invoke-PowerDump|Invoke-TokenManipulation|Exploit-Jboss|Invoke-ThunderStruck|Invoke-VoiceTroll|Set-Wallpaper|Invoke-InveighRelay|Invoke-PsExec|Invoke-SSHCommand|Get-SecurityPackages|Install-SSP|Invoke-BackdoorLNK|PowerBreach|Get-GPPPassword|Get-SiteListPassword|Get-System|Invoke-BypassUAC|Invoke-Tater|Invoke-WScriptBypassUAC|PowerUp|PowerView|Get-RickAstley|Find-Fruit|HTTP-Login|Find-TrustedDocuments|Get-ComputerDetails|Get-SystemDNSServer|Invoke-Paranoia|Invoke-WinEnum|Get-SPN|Invoke-ARPScan|Invoke-PortScan|Invoke-ReverseDNSLookup|Invoke-SMBScanner|PSAttack-BuildTool|Powersploit|Invoke-Mimikatz|Get-GPPPassword|Invoke-NinjaCopy|Invoke-Shellcode|Invoke-WMICommand|VolumeShadowCopyTools|PowerTools|PowerUp|PowerView|Nishang|Powercat|Inveigh|AdjustTokenPrivileges|IMAGE_NT_OPTIONAL_HDR64_MAGIC|Management.Automation.RuntimeException|Microsoft.Win32.UnsafeNativeMethods|ReadProcessMemory.Invoke|Runtime.InteropServices|SE_PRIVILEGE_ENABLED|System.Security.Cryptography|System.Reflection.AssemblyName|System.Runtime.InteropServices|LSA_UNICODE_STRING|MiniDumpWriteDump|PAGE_EXECUTE_READ|Net.Sockets.SocketFlags|Reflection.Assembly|SECURITY_DELEGATION|TOKEN_ADJUST_PRIVILEGES|TOKEN_ALL_ACCESS|TOKEN_ASSIGN_PRIMARY|TOKEN_DUPLICATE|TOKEN_ELEVATION|TOKEN_IMPERSONATE|TOKEN_INFORMATION_CLASS|TOKEN_PRIVILEGES|TOKEN_QUERY|Metasploit|Advapi32.dll|kernel32.dll|msvcrt.dll|ntdll.dll|secur32.dll|user32.dll'

