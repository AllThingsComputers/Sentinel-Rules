// Title of Detection: PowerShell Hacker Tools and Their Popular Cmdlets
// Authorship & Contact: https://allthingscomputers.medium.com | https://twitter.com/allthingshandle | https://allthingscomputersblog.wordpress.com/
// Description of the Detection: Detects PowerShell Cmdlets from tools like MimiKatz, PowerSploit, PowerView, Nishang, PowerUp, and Empire.
// References: https://adsecurity.org/?p=2921

SysmonEvent
| where Image contains "powershell"
| where CommandLine matches regex @"(?i)(Invoke-DllInjection|Invoke-Shellcode|Invoke-WmiCommand|Get-GPPPassword|Get-Keystrokes|Get-TimedScreenshot|Get-VaultCredential|Invoke-CredentialInjection|Invoke-Mimikatz|Invoke-NinjaCopy|Invoke-TokenManipulation|Out-Minidump|VolumeShadowCopyTools|Invoke-ReflectivePEInjection|PowerView|Get-NetUser|Get-NetGroup|Get-NetGroupMember|Get-NetLocalGroup|Get-NetSession|Invoke-UserHunter|Get-NetOU|Find-GPOLocation|Get-NetGPOGroup|Get-ObjectACL|Add-ObjectACL|Invoke-ACLScanner|Set-ADObject|Invoke-DowngradeAccount|Get-NetForest|Get-NetForestTrust|Get-NetForestDomain|Get-NetDomainTrust|Get-MapDomainTrust|PowerUp|Get-ServiceUnquoted|Get-ServiceFilePermission|Get-ServicePermission|Invoke-ServiceAbuse|Install-ServiceBinary|Get-RegAutoLogon|Get-VulnAutoRun|Get-VulnSchTask|Get-UnattendedInstallFile|Get-WebConfig|Get-ApplicationHost|Get-RegAlwaysInstallElevated|Nishang|Get-Unconstrained|Add-RegBackdoor|Add-ScrnSaveBackdoor|Gupt-Backdoor|Invoke-ADSBackdoor|Enabled-DuplicateToken|Invoke-PsUaCme|Remove-Update|Check-VM|Copy-VSS|Get-Information|Get-LSASecret|Get-PassHashes|Show-TargetScreen|Port-Scan|Invoke-PoshRatHttp|Invoke-PowerShellTCP|Invoke-PowerShellWMI|Add-Exfiltration|Add-Persistence|Do-Exfiltration|Start-CaptureServer|Invoke-DllInjection|Invoke-ReflectivePEInjection|Invoke-ShellCode|Get-ChromeDump|Get-ClipboardContents|Get-FoxDump|Get-IndexedItem|Get-Keystrokes|Get-Screenshot|Invoke-Inveigh|Invoke-NetRipper|Invoke-NinjaCopy|Out-Minidump|Invoke-EgressCheck|Invoke-PostExfil|Invoke-PSInject|Invoke-RunAs|MailRaider|New-HoneyHash|Set-MacAttribute|Get-VaultCredential|Invoke-DCSync|Invoke-PowerDump|Exploit-Jboss|Invoke-ThunderStruck|Invoke-VoiceTroll|Set-Wallpaper|Invoke-InveighRelay|Invoke-PsExec|Invoke-SSHCommand|Get-SecurityPackages|Install-SSP|Invoke-BackdoorLNK|PowerBreach|Get-GPPPassword|Get-SiteListPassword|Get-System|Invoke-BypassUAC|Invoke-Tater|Invoke-WScriptBypassUAC|PowerUp|PowerView|Find-TrustedDocuments|Get-ComputerDetails|Get-SystemDNSServer|Invoke-Paranoia|Invoke-WinEnum|Get-SPN|Invoke-ARPScan|Invoke-PortScan|Invoke-ReverseDNSLookup|Invoke-SMBScanner|PSAttack-BuildTool|PowerSploit|Metasploit|kernel32.dll|ntdll.dll|secur32.dll|user32.dll|Advapi32.dll|Microsoft.Win32.UnsafeNativeMethods|ReadProcessMemory.Invoke|System.Security.Cryptography|MiniDumpWriteDump|Net.Sockets.SocketFlags|System.Reflection.Assembly|Runtime.InteropServices)"
