// Title of Detection:  Important Windows Registry Key Modified
// Authorship & Contact: https://allthingscomputers.medium.com  https://twitter.com/allthingshandle  https://allthingscomputersblog.wordpress.com/ 
 // Description of the Detection:  Changes made to a Registry Key and/or Key value (ex: Windows EventID 4657 or Sysmon EventID 13|14) 
// References (if available):   https://attack.mitre.org/datasources/DS0024/   https://attack.mitre.org/techniques/T1546/012/   https://attack.mitre.org/techniques/T1546/015/   https://attack.mitre.org/techniques/T1564/002/   https://attack.mitre.org/techniques/T1574/011/   https://attack.mitre.org/techniques/T1562/001/   https://attack.mitre.org/techniques/T1137/002/   https://attack.mitre.org/techniques/T1562/004/   https://attack.mitre.org/techniques/T1553/   https://attack.mitre.org/techniques/T1562/006/ 
https://attack.mitre.org/techniques/T1553/006/    https://attack.mitre.org/techniques/T1505/005/   https://attack.mitre.org/techniques/T1547/003/   https://attack.mitre.org/techniques/T1547/012/   https://attack.mitre.org/techniques/T1546/007/   https://attack.mitre.org/techniques/T1546/009/   https://attack.mitre.org/techniques/T1546/001/   https://attack.mitre.org/techniques/T1547/014/   https://attack.mitre.org/techniques/T1547/002/    https://attack.mitre.org/techniques/T1546/002/   https://attack.mitre.org/techniques/T1553/003/   https://attack.mitre.org/techniques/T1547/005/   https://attack.mitre.org/techniques/T1547/010/   https://attack.mitre.org/techniques/T1218/002 
// The Logic of the Detection or Query Begins Below This Line
SysmonEvent
| where  EventID in (13, 14) and EventType in ("SetValue", "DeleteValue") and TargetObject matches regex @'(?i))HKCU\\Software\\Classes\\mscfile\\shell\\open\\command|HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\App Paths\\control.exe|HKCU\\Software\\Classes\\exefile\\shell\\runas\\command\\isolatedCommand|HKLM\\Software\\Policies\\Microsoft\\Windows NT\\DNSClient\\EnableMulticast|HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\LSASS.exe|HKLM\\SYSTEM\\CurrentControlSet\Control\\Print\\Monitors|HKLM\\SYSTEM\\ControlSet001\\ Control\\Print\\Environments\\.*\\Print Processors\\.*\\Driver|HKLM\\SYSTEM\\CurrentControlSet\Control\\Print\\Environments\\.*\\Print Processors\\.*\\Driver|HKLM\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\|HKLM\\SYSTEM\\CurrentControlSet\\Services|HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\FileExts|HKLM\\SOFTWARE\\Microsoft\\Netsh|HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options|HKLM\\SOFTWARE\\Microsoft\\Windows
NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList|HKLM\\SYSTEM\\CurrentControlSet\Control\\Session Manager\\Environment\\Path|HKLM\\SYSTEM\\CurrentControlSet\\Services|HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender|HKLM\\SYSTEM\\CurrentControlSet\Services\\SharedAccess\\Parameters\\FirewallPolicy|HKLM\\SYSTEM\
\CurrentControlSet\Control\\WMI\\Autologger\\|HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*|HKLM\\SYSTEM\\CurrentControlSet\Control\\SafeBoot\\Minimal|HKCU\\Software\\Policies\\Microsoft\\PreviousVersions\\DisableLocalPage|HKLM\\System\\CurrentControlSet\\services\\TermService\\Parameters\\|HKLM\\SYSTEM\\\CurrentControlSet\Control\\Lsa\\Notification Packages|HKLM\SOFTWARE\\Microsoft\\EnterpriseCertificates\\Root\\Certificates\\|HKLM\\SOFTWARE\\Microsoft\\Cryptography\\OID|HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\OID|HKLM\\SOFTWARE\\Microsoft\\Cryptography\\Providers\\Trust|HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Providers\\Trust|HKCU\\Software\\Policies\\Microsoft\\Windows NT\\Driver Signing|HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Control Panel\\|(HKLM|HKCU)\\Software\\Microsoft\\Windows\\CurrentVersion\\Control Panel\\|HKLM\Software\\Microsoft\\Windows\\CurrentVersion\\Controls Folder.*\\Shellex\\PropertySheetHandlers|HKLM\\SOFTWARE(\\Wow6432Node)?\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\|HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\|HKCU\\Software\\Classes\\Folder\\shell\\open\\command|HKCU\\Software\\Classes\\CLSID\\|HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList|HKLM\\SYSTEM\\CurrentControlSet\Control\\Session Manager\\Environment\\Path|HKLM\\SYSTEM\\CurrentControlSet\\Services|HKLM\\SYSTEM\\CurrentControlSet\\Services\\servicename\\Parameters\\ServiceDII|HKLM\\SOFTWARE\\Microsoft\\AMSI\\Providers|HKLM\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\StandardProfile|HKLM\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy|HKLM\\SYSTEM\\CurrentControlSet\Control\\CrashControl\\CrashDumpEnabled|HKCU\\Software\\Microsoft\\Office test\\Special\\Perf|HKLM\\Software\\Microsoft\\Office test\\Special\\Perf|HKLM\\System\\CurrentControlSet\\services\\TermService\\Parameters\\|HKLM\\SOFTWARE\\Policies\\Microsoft\\SystemCertificates\\Root\\ProtectedRoots|HKLM\\SOFTWARE\\Microsoft\\Cryptography\\OID|HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\OID|HKLM\\SOFTWARE\\Microsoft\\Cryptography\\Providers\\Trust|HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Provider\\Trust|HKLM\\SOFTWARE\\Policies\\Microsoft\\SystemCertificates\\Root\\ProtectedRoots|HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Control Panel\\NameSpace|HKCR\\CLSID|(HKLM|HKCU)\\Software\\Microsoft\\Windows\\CurrentVersion\\ControlPanel|HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Controls Folder.*\\Shellex\\PropertySheetHandlers|HKLM\\Software\\Policies\\Microsoft\\Windows NT\\DNSClient\\EnableMulticast|HKCU\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\load|HKLM\\System\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\|HKLM\\Software(\\Wow6432Node)?\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\|HKCU\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\|\\Software\\Microsoft\\Windows
NT\\CurrentVersion\\Winlogon\\Userinit|\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell|HKLM\\SYSTEM\\CurrentControlSet\Control\\Lsa\\Security Packages|HKLM\\SYSTEM\\CurrentControlSet\Control\\Lsa\\OSConfig\\Security Packages|HKLM\\SYSTEM\\CurrentControlSet\Control\\Lsa\\RunAsPPL|HKLM\\SYSTEM\\CurrentControlSet\Control\\Print\\Monitors
HKLM\\SYSTEM\\ControlSet001\\Control\\Print\\Environments\\.*\\Print Processors\\.*\\Driver|HKLM\\SYSTEM\\CurrentControlSet\Control\\Print\\Environments\\.*\\Print Processors\\.*\\Driver|SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows|HKLM\\System\\CurrentControlSet\\Control\\Session Manager|HKLM\\SOFTWARE\\Microsoft\\Windows NT\CurrentVersion\\Image File Execution
Options|HKLM\\SOFTWARE\\Microsoft\\Netsh|HKCU\\Control Panel\\Desktop\\|HKCR\\txtfile\\shell\\open\\command|HKCR\\txtfile\\shell\\print\\command|HKCR\\txtfile\\shell\\printto\\command|HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\FileExts|HKLM\\SYSTEM\\CurrentControlSet\\Services|HKLM\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\|HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\'
