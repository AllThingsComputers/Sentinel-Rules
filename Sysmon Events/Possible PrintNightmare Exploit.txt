// Title of Detection:  Possible PrintNightmare Exploit
// Authorship & Contact: https://allthingscomputers.medium.com  https://twitter.com/allthingshandle  https://allthingscomputersblog.wordpress.com/ 
// Description of the Detection: 
// References (if available):   pg38  https://resource.redcanary.com/rs/003-YRU-314/images/2022/Threat-Detection-Report-RedCanary.pdf
// The Logic of the Detection or Query Begins Below This Line
SysmonEvent
| where (EventID == 11 and TargetFilename matches regex @"(?i)C:\\Windows\\System32\\spool\\drivers\\(x64/W32X86)\\.*\.dll$") or (EventID == 7 and ImageLoaded matches regex @"(?i)C:\\Windows\\System32\\spool\\drivers\\(x64/W32X86)\\*\.dll$") or (EventID in (12, 13, 14) and TargetObject matches regex @"(?i)\\System\\CurrentControlSet\Control\\Print\\Environments\\Windows (x64\\Drivers\\Version-.* |NT x86)\\.*\.dll") or (EventID == 1 and ParentImage matches regex @"(?i)\\spoolsv\.exe") or (TargetObject matches regex @"(?i)Software\\Policies\\Microsoft\\Windows NT\\Printers\\PointAndPrint" and TargetObject contains "1")
