// Title of Detection:   Unusual file Path in command Line
// Authorship & Contact: https://allthingscomputers.medium.com  https://twitter.com/allthingshandle  https://allthingscomputersblog.wordpress.com/ 
 // Description of the Detection: This can be indicative of malware
// References (if available):  https://www.socinvestigation.com/detections-of-malware-execution-from-unusual-directories/
// The Logic of the Detection or Query Begins Below This Line
SysmonEvent
| where Image matches regex @'(?i)(wscript|cscript|rundll32|regsvr32|cmstp|RegAsm|installutil|mshta|RegSvcs|powershell|pwsh|cmd)\.exe)' and Image matches regex @(?i)(C:\\PerfLogs\\|C:\\Users\\Public\\|C:\\Users\\Default\\|C:\\Windows\\Tasks\\|C:\\Intel\\|C:\\AMD\\Temp\\|C:\\Windows\\AppReadiness\\|C:\\Windows\\ServiceState\\|C:\\Windows\\security\\|C:\\Windows\\IdentityCRL\\|C:\\Windows\\Branding\\|C:\\Windows\\csc|C:\\Windows\\DigitalLocker\\|C:\\Windows\\en-US\\|C:\\Windows\\wlansvc\\|C:\\Windows\\Prefetch\\|C:\\Windows\\Fonts\\|C:\\Windows\\diagnostics\\|C:\\Windows\\TAPI\\|C:\\Windows\\INF\\|C:\\Windows\\System32\\Speech\\|C:\\windows\\tracing\\|C:\\windows\\IME\\\|c:\\Windows\\Performance\\|C:\\windows\\intel\\|C:\\windows\\ms\\|C:\\Windows\\dot3svc\\|C:\\Windows\\ServiceProfiles\\|C:\\Windows\\panther\\|C:\\Windows\\RemotePackages\\|C:\\Windows\\OCR\\|C:\\Windows\\appcompat\\|C:\\Windows\\apppatch\\|C:\\Windows\\addins\\|C:\\Windows\\Setup\\|C:\\Windows\\Help\\|C:\\Windows\\SKB\\|C:\\Windows\\Vss\\|C:\\Windows\\Web\\|C:\\Windows\\servicing\\|C:\\Windows\\CbsTemp\\|C:\\Windows\\Logs\\|C:\\Windows\\WaaS\\|C:\\Windows\\twain_32\\|C:\\Windows\\ShellExperiences\\|C:\\Windows\\ShellComponents\\|C:\\Windows\\PLA\\|C:\\Windows\\Migration\\|C:\\Windows\\debug\\|C:\\Windows\\Cursors\\|C:\\ Windows\\Containers\\|C:\\Windows\\Boot\\|C:\\Windows\\bcastdvr\\|C:\\Windows\\assembly\\|C:\\Windows\\Textinput\\|C:\\Windows\\security\\|C:\\Windows\\schemas\\|C:\\Windows\\SchCache\\|C:\\Windows\\Resources\\|C:\\Windows\\rescache\\|C:\\Windows\\Provisioning\\|C:\\Windows\\PrintDialog\\|C:\\Windows\\Policy Definitions\\|C:\\Windows\\media\\|C:\\Windows\\Globalization\\|C:\\Windows\\L2Schemas\\|C:\\Windows\\LiveKernelReports\\|C:\\Windows\\ModemLogs\\|C:\\Windows\\ImmersiveControlPanel\\|C:\\$Recycle.Bin\\\' and ParentImage matches regex @(?i)(C:\\WINDOWS\\System32\\DriverStore\\FileRepository\\. *igfxCUIService.*\.exe|C:\\Windows\\System32\\spacedeskService\.exe|C:\\Program Files\\Dell\\SupportAssistAgent\\SRE\\SRE\.exe")' and not(Image matches regex @"(?i)rundll32\.exe" and '(?i)(uxtheme.dll,#64"|PRINTUI.DLL,PrintUIEntry)')
