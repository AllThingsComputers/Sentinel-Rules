// Title of Detection:  abnormal file-based execution of Mshta content 
// Authorship & Contact: https://allthingscomputers.medium.com  https://twitter.com/allthingshandle  https://allthingscomputersblog.wordpress.com/ 
 // Description of the Detection:  Normal file-based execution of Mshta content is typically observed on disk and executes HTA content in files ending with the .hta file extension. Detection analytics targeting the execution of remotely hosted HTA content-either via URI or UNC path, from an alternate data stream, or from files without the .hta extension-can provide defenders with high-signal analytics. A behavioural analytic that might be helpful in certain environments is to simply look for mshta.exe executing and making an external network connection. Of course, you'll need to baseline against normal behaviours and tune out alerting that comes from legitimate software. Another detection opportunity relates instances of Mshta downloading and executing HTA content from a URI. 
// References (if available):   page 31  https://resource.redcanary.com/rs/003-YRU-314/images/2021-Threat-Detection-Report.pdf
// The Logic of the Detection or Query Begins Below This Line
SysmonEvent
| where (EventID == 1 and Image !endswith "mshta.exe" and CommandLine contains ".hta") or (EventID == 1 and Image endswith "mshta.exe" and Image matches regex "(?i).*\.([^(hta)]|txt|com|exe|doc|ps1|psm1|bat|doc|docx|rtf)") or (EventID == 1 and Image endswith "mshta.exe" and Image matches regex "(?i)(www|http|\.com|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}).*\.hta") or (EventID == 1 and Image endswith "mshta.exe" and "(?i).*\.hta" and not('(?i)\sC:\\')) or (EventID == 1 and Image endswith "mshta.exe" and Image matches regex "\b.*:.*\b") or (EventID == 3 and Image ends with "mshta.exe" and not(ipv4_is_private(tostring(DestinationIp)))) or (EventID: == 11 and TargetFilename endswith ".hta")'
